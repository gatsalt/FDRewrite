'''
/* Copyright (C) Saltworks Security, LLC - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
* Written by Saltworks Security, LLC  (www.saltworks.io) , 2019
*/
'''
import json
import sys
import csv
import os
import requests
#from sscVulCount import sscVulCount
from ABCsscVulCount import sscVulCounts
from ABCfodIssCount import fodIssCounts
from ABClasticUtils2 import elasticUtil

import datetime

with open('settings.json') as json_data:
    settings = json.load(json_data)

CSVSSCAggRptfilePath = settings['CSVSSCAggRptfilePath']

_url = settings['elasticURL']
es = elasticUtil(_url)

try:
    if os.path.isfile(CSVSSCAggRptfilePath):
        os.unlink(CSVSSCAggRptfilePath)
except Exception as e1:
    print(e1)
    sys.exit()


iRecToReturn = 1000

sscVulns = sscVulCounts()

fodIsss = fodIssCounts()

def initBlankReportObject():

    _reportInfo = {
        '_IssueName': '',
        '_UAID': '',
        '_ReleaseName': '',
        '_ReleaseId': 0,
        '_Status': '',
        '_Risk': '',
        '_FoundDate': '',
        '_RemovedDate': '',
        '_ScanType': '',
        '_RecCount': 0,
        '_Source': '',
        '_href': ''
        }

    return _reportInfo
       

rptsToWrite = {'data': []}


def addVuls(vuls, inCount):

    loopCount = inCount
    for vul in vuls['hits']['hits']:
       
        loopCount = loopCount + 1

        sscVulns.addVul(vul)

        if (loopCount % 1000) == 0:

            print('{}\t{}\t{}\t{}\t{}'.format(loopCount, vul['_source']['projectVersionId'],
                vul['_source']['issueName'],
                vul['_source']['engineCategory'], 
                vul['_source']['suppressed']))
    return loopCount

def addIsss(isss, inCount):

    loopCount = inCount
    for iss in isss['hits']['hits']:
       
        loopCount = loopCount + 1

        fodIsss.addIss(iss)

        if (loopCount % 1000) == 0:

            print('{}\t{}\t{}\t{}\t{}'.format(loopCount, iss['_source']['releaseId'],
                iss['_source']['category'],
                iss['_source']['scantype'], 
                iss['_source']['isSuppressed']))
    return loopCount


print("Start SSC Accumulation: {}".format(datetime.datetime.now()))
'''
Go through all SSC Vulnerabilities table and accumulate totals by releaseid
'''
_Headers = {'Accept': 'application/json',
            'Content-Type': 'application/json'}

url = 'http://localhost:9200/sscprojissues/_search?scroll=5m'

searchData = {
    "size": iRecToReturn,
    "sort": [
        "projectVersionId" 
        ]
    
    }

response = requests.post(url, data=json.dumps(searchData), headers=_Headers)

vuls = json.loads(response.text)

_scroll_id = vuls['_scroll_id']
iTotal = vuls['hits']['total']

print('Total Recs: {}'.format(iTotal))

iCount = 0 
iCount = addVuls(vuls, iCount)

#Not loop
bKeepGoing = True 
while bKeepGoing:
    url = 'http://localhost:9200/_search/scroll'

    searchData = {
        "scroll": "5m",
        "scroll_id": _scroll_id  
        }

    response = requests.post(url, data=json.dumps(searchData), headers=_Headers)

    vuls = json.loads(response.text)
    iCount = addVuls(vuls, iCount)
    if iCount >= iTotal:
    #if iCount >= 10000:
        bKeepGoing = False


print("End SSC Accumulation: {}".format(datetime.datetime.now()))

'''
end of accumulating SSC totals
'''

print("Start FOD Accumulation: {}".format(datetime.datetime.now()))

_Headers = {'Accept': 'application/json',
            'Content-Type': 'application/json'}

url = 'http://localhost:9200/fodrelissues/_search?scroll=5m'

searchData = {
    "size": iRecToReturn,
    "sort": [
        "releaseId" 
        ]
    
    }

response = requests.post(url, data=json.dumps(searchData), headers=_Headers)

isss = json.loads(response.text)

_scroll_id = isss['_scroll_id']
iTotal = isss['hits']['total']

print('Total Recs: {}'.format(iTotal))

iCount = 0 
iCount = addIsss(isss, iCount)

#Not loop
bKeepGoing = True 
while bKeepGoing:
    url = 'http://localhost:9200/_search/scroll'

    searchData = {
        "scroll": "5m",
        "scroll_id": _scroll_id  
        }

    response = requests.post(url, data=json.dumps(searchData), headers=_Headers)

    isss = json.loads(response.text)
    iCount = addIsss(isss, iCount)
    if iCount >= iTotal:
    #if iCount >= 10000:
        bKeepGoing = False

print("End FOD Accumulation: {}".format(datetime.datetime.now()))

projid = ''
holdUAID = ''
holdReleaseName = ''

'''
process SSC vulnerabilities - check report table to see if release was reported using SSC information (FOP) and only include in the report if so
'''

for vulKey in sscVulns.sscVulns:

    vul = (sscVulns.sscVulns[vulKey])
    if projid != vul["projectVersionId"]:

        projid = vul["projectVersionId"]
        print (projid)

        foundproject = sscVulns.searchSSCProjectsforProjectId(projid)

        if foundproject['hits']['total'] == 1:
            holdUAID = json.dumps(foundproject['hits']['hits'][0]['_source']['project']['name'])
            
            if holdUAID[1:5] == 'UAID':
                stripUAID = holdUAID[1:11]
            else:    
                stripUAID = holdUAID
            #print(stripUAID)
            remqUAID = format(stripUAID).replace('"','')
            #print(remqUAID)

            holdReleaseName = json.dumps(foundproject['hits']['hits'][0]['_source']['name'])
            remqReleaseName = format(holdReleaseName).replace('"','')
            #holdhref = json.dumps(foundproject['hits']['hits'][0]['_source']['_href'])
            
            holdhref = "https://fortify.1dc.com/ssc/html/ssc/version/{}/fix/null/?filterset=a243b195-0a59-3f8b-1403-d55b7a7d78e6".format(projid)
            remqhref = format(holdhref).replace('"','')

        reportfromSSC = False

        foundARERec = es.searchAppRelInfoDataReleaseId(projid)

        if foundARERec['hits']['total'] == 1:
            if ((foundARERec['hits']['hits'][0]['_source']['dataSource'] == 'FOP') or (foundARERec['hits']['hits'][0]['_source']['dataSource'] == 'FOP*')) :
                reportfromSSC = True

        print(reportfromSSC)

    if reportfromSSC == True:
        #print(vul)

        reportInfo = initBlankReportObject()

        reportInfo['_IssueName'] = vul["issueName"]
        reportInfo['_ReleaseId'] = vul["projectVersionId"]
        reportInfo['_Status'] = vul["status"]
        reportInfo['_Risk'] = vul["friority"]  
        reportInfo['_FoundDate'] = vul["foundDate"]
        reportInfo['_RemovedDate'] = vul["removedDate"]
        reportInfo['_ScanType'] = vul["engineCategory"]
        reportInfo['_Reccount'] = vul["reccount"]
        reportInfo['_Source'] = 'FOP'
        reportInfo['_UAID'] = remqUAID
        reportInfo['_ReleaseName'] = remqReleaseName
        reportInfo['_href'] = remqhref

        rptsToWrite['data'].append(reportInfo)

    #print(reportInfo)

'''
end processing SSC vulnerabilities
'''

'''
process FOD vulnerabilities - check report table to see if release was reported using FOD information and only include in the report if so
'''

relid = ''

for issKey in fodIsss.fodIsss:

    iss = (fodIsss.fodIsss[issKey])
    if relid != iss["releaseId"]:

        relid = iss["releaseId"]
        print (relid)

        foundrelease = fodIsss.searchFODReleasesforReleaseId(relid)

        #print(foundrelease)

        if foundrelease['hits']['total'] == 1:
            holdUAID = json.dumps(foundrelease['hits']['hits'][0]['_source']['applicationName'])
            
            if holdUAID[1:5] == 'UAID':
                stripUAID = holdUAID[1:11]
            else:    
                stripUAID = holdUAID
            
            #print(stripUAID)
            remqUAID = format(stripUAID).replace('"','')
            #print(remqUAID)

            holdReleaseName = json.dumps(foundrelease['hits']['hits'][0]['_source']['releaseName'])
            remqReleaseName = format(holdReleaseName).replace('"','')
            #holdhref = json.dumps(foundproject['hits']['hits'][0]['_source']['_href'])
            
            holdhref = "https://ams.fortify.com/Releases/{}/Overview".format(relid)
            remqhref = format(holdhref).replace('"','')

        reportfromFOD = False

        foundARERec = es.searchAppRelInfoDataReleaseId(relid)

        if foundARERec['hits']['total'] == 1:
            if ((foundARERec['hits']['hits'][0]['_source']['dataSource'] == 'FOD') or (foundARERec['hits']['hits'][0]['_source']['dataSource'] == 'FOD*') or (foundARERec['hits']['hits'][0]['_source']['dataSource'] == 'FODonly')):
                reportfromFOD = True

        print(reportfromFOD)

    if reportfromFOD == True:

        #print(iss)

        reportInfo = initBlankReportObject()

        #print(reportInfo)

        reportInfo['_IssueName'] = iss["category"]
        reportInfo['_ReleaseId'] = iss["releaseId"]
        reportInfo['_Status'] = iss["status"]
        reportInfo['_Risk'] = iss["severityString"]  
        reportInfo['_FoundDate'] = iss["introducedDate"]
        reportInfo['_RemovedDate'] = iss["removedDate"]
        reportInfo['_ScanType'] = iss["scantype"]
        reportInfo['_Reccount'] = iss["reccount"]
        reportInfo['_Source'] = 'FOD'
        reportInfo['_UAID'] = remqUAID
        reportInfo['_ReleaseName'] = remqReleaseName
        reportInfo['_href'] = remqhref

        rptsToWrite['data'].append(reportInfo)

'''
end processing FOD vulnerabilities
'''
  

with open(CSVSSCAggRptfilePath, 'w', newline='') as csvrfile:
    rfieldnames = ['Issue Name', 'UAID', 'Release Name', 'Release Id', 'Status', 'Risk', 'FoundDate', 'RemovedDate', 'ScanType', 'RecCount', 'Source', 'Link']

    writer = csv.DictWriter(csvrfile, fieldnames=rfieldnames)
    writer.writeheader()

    for rptToWrite in rptsToWrite['data']:

        
        writer.writerow(
        {
            'Issue Name': rptToWrite['_IssueName'],
            'UAID': rptToWrite['_UAID'],
            'Release Name': rptToWrite['_ReleaseName'],
            'Release Id': rptToWrite['_ReleaseId'],
            'Status': rptToWrite['_Status'],
            'Risk': rptToWrite['_Risk'],
            'FoundDate': rptToWrite['_FoundDate'],
            'RemovedDate': rptToWrite['_RemovedDate'],
            'ScanType': rptToWrite['_ScanType'],
            'RecCount': rptToWrite['_Reccount'],
            'Source': rptToWrite['_Source'],
            'Link': rptToWrite['_href']
        })
    #for vulrec in vul:

    #    print (vulrec)

    